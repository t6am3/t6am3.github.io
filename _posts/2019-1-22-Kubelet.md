# Kubelet
## 相关博客
[Kubelet的工作流程](https://www.jianshu.com/p/4a068611b43e)  
[Kubelet组件解析](https://blog.csdn.net/jettery/article/details/78891733)  
[Kubelet运行机制分析](https://www.jianshu.com/p/639903727a60)  
[Kubelet与apiserver通信](https://yq.aliyun.com/articles/647345)
___
> Kubelet组件运行在Node节点上，维持运行中的Pods以及提供kuberntes运行时环境，主要完成以下使命：  
* 监视分配给该Node节点的pods
* 挂载pod所需要的volumes
* 下载pod的secret
* 通过docker/rkt来运行pod中的容器
* 周期的执行pod中为容器定义的liveness探针
* **上报pod的状态给系统的其他组件**
* **上报Node的状态**

我们所关注的是最后两点
![Kubelet的架构图](https://img-blog.csdn.net/20171225131332796?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvamV0dGVyeQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

我们主要关注以下组件：
* cAdvisor:监视node以及pod的状态信息
* heartbeatClient:?尚未确定是心跳，[在查资料的时候，与apiServer的通信由kubeClient提供]

这两个dependencies在kubelet启动的时候被创建好。
具体方式为
k8s.io/kubernets/cmd/kubelet/kubelet.go 中先创建命令NewKubeletCommand,然后再运行
k8s.io/kubernets/cmd/kubelet/app/server.go中有具体的NewkubeletCommand，不是很懂golang的语法但是应该是创建了一个可以呈现runnable一样的命令
在server.go中第236行
创建了kubeletServer和kubeletDeps
kubeletServer的内容就是一些flags和一些Config
kubeletDeps实际上就是所需要的各个组件
跳至384行，展示了kubeletDeps分为哪些内容,其中就包括了我们的cAdvisorInterface & heartbeatClient

不去管Run& run，我们直接找cAdvisor 与 heartbeatClient
我已经编译完了，这两个组件的具体位置在:
cAdvisor: k8s.io/kubernets/pkg/kubelet/cadvisor/cadvisor_linux.go
heartbeatClient:
这个玩意儿跳来跳去的，在server.go的第587行，
`kubeDeps.HeartbeatClient, err = clientset.NewForConfig(&heartbeatClientConfig)`
所以应该是由clientset创建的
这个clientset的具体位置是vendor/k8s.io/clieng-go/kubernets/clientset.go

接下来我们说一说这两个位置的代码  
先说cAdvisor，它里面获得各种info的函数跳到最后发现是由一个Manager of cAdvisor-monitored containers提供的(/usr/local/go/src/k8s.io/kubernetes/vendor/github.com/google/cadvisor/manager/manager.go),这里面有各种info的get方法，具体去查，（比如只跟containerInfo）,会发现实际的get是从已经做好的containerName*containerData的一个map里面去搜索并取出。往上翻，这个map是由New方法做好的，new方法里面做manager的时候直接用了containerData，我也找不到来源，可能使不懂语法这是个全局的变量？师兄可以接着这个地方找一下

再说一下clientset.go，这里面调用的NewForConfig是根据传进来的config创建了一个制式的heartbeatClient，具体的内容很多了，没看
想了一下，这个地方好像只是定制一个heartclient，实际上client的运行方式没有写在这里。
找来找去，发现实际上的kubelet实现是在k8s.io/kubernetes/pkg/kubelet/kubelet.go里面，在cmd里面只是kubernetes运行组件的一种固定形式，在这里面有着所有的循环，事件更新，在这里面把需要的组件传给了kublet.nodeLeaseController(包括heartbeatClient，第870行),并在1409行开始Run，在这后面又是一连串的跳跳跳


